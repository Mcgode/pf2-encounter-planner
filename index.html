<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>PF2e Encounter Planner</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
</head>

<body>
    <!-- Body content -->
    <ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="planner-tab" data-toggle="tab" href="#planner" role="tab" aria-controls="planner" aria-selected="true">Encounter planner</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">Encounter history</a>
        </li>
    </ul>

    <div class="tab-content" id="mainContent">
        <div class="tab-pane fade show active" id="planner" role="tabpanel" aria-labelledby="planner-tab">
            <h1>Encounter planner</h1>

            <div class="accordion" id="encountersAccordion">
            </div>

            <button class="btn btn-outline-primary" data-toggle="modal" data-target="#addEncounterModal">
                Add new encounter
            </button>

            <div class="modal fade" id="addEncounterModal" tabindex="-1" role="dialog" aria-labelledby="addEncounterModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addEncounterModalLabel">Add a new encounter</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="addEncounterForm" action="javascript:addEncounter(encounterName.value)">
                                <div class="form-group">
                                    <label for="encounterName" class="col-form-label">Encounter name:</label>
                                    <input type="text" class="form-control" id="encounterName" name="encounterName">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="document.forms['addEncounterForm'].submit()">
                                Add encounter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="renameEncounterModal" tabindex="-1" role="dialog" aria-labelledby="renameEncounterModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="renameEncounterModalLabel">Rename the encounter</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="renameEncounterForm" action="javascript:renameEncounter(encounterNewName.value)">
                                <div class="form-group">
                                    <label for="encounterNewName" class="col-form-label">Encounter name:</label>
                                    <input type="text" class="form-control" id="encounterNewName" name="encounterNewName">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="document.forms['renameEncounterForm'].submit()">
                                Rename encounter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="setElementModal" tabindex="-1" role="dialog" aria-labelledby="setElementModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="setElementModalLabel">Add an encounter element</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="setElementModalForm" action="javascript:confirmElementData">
                                <div class="form-group">
                                    <label for="elementName" class="col-form-label">Encounter element name:</label>
                                    <input type="text" class="form-control" id="elementName" name="elementName">
                                </div>

                                <ul class="nav nav-tabs" id="elementTab" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="custom-tab" data-toggle="tab" href="#custom" role="tab" aria-controls="custom" aria-selected="true">Custom element</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="fight-tab" data-toggle="tab" href="#fight" role="tab" aria-controls="fight" aria-selected="false">Fight</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="accomplishment-tab" data-toggle="tab" href="#accomplishment" role="tab" aria-controls="accomplishment" aria-selected="false">Accomplishment</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="hazard-tab" data-toggle="tab" href="#hazard" role="tab" aria-controls="hazard" aria-selected="false">Hazard</a>
                                    </li>
                                </ul>

                                <div class="tab-content" id="elementTabContent">
                                    <div class="tab-pane fade show active" id="custom" role="tabpanel" aria-labelledby="custom-tab">
                                        <div class="form-group">
                                            <label for="elementCustomXp" class="col-form-label">Custom XP amount:</label>
                                            <input type="number" class="form-control" id="elementCustomXp" name="elementCustomXp">
                                        </div>
                                    </div>

                                    <div class="tab-pane fade" id="fight" role="tabpanel" aria-labelledby="fight-tab">
                                        <div class="list-group" id="elementCreatureList"></div>
                                        <button class="btn btn-outline-primary btn-top-margin">
                                            Add more creatures
                                        </button>
                                    </div>

                                    <div class="tab-pane fade" id="accomplishment" role="tabpanel" aria-labelledby="accomplishment-tab">
                                        <label for="elementAccomplishmentLevel" class="col-form-label">Accomplishment level:</label>
                                        <select id="elementAccomplishmentLevel" name="elementAccomplishmentLevel">
                                            <option value="Minor accomplishment">Minor accomplishment</option>
                                            <option value="Moderate accomplishment">Moderate accomplishment</option>
                                            <option value="Major accomplishment">Major accomplishment</option>
                                        </select>
                                    </div>

                                    <div class="tab-pane fade" id="hazard" role="tabpanel" aria-labelledby="hazard-tab">
                                        <div class="list-group" id="elementHazardList"></div>
                                        <button class="btn btn-outline-primary btn-top-margin">
                                            Add more hazards
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="setElementModalConfirm" onclick="confirmElementData()">
                                Add element
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
            Encounter history
        </div>
    </div>

    <!-- Scripts loaders -->
    <script src="build/pf2_encounter_planner.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        let session = PF2EncounterPlanner.Session.makeSession()
        let selectedEncounter = null
        let selectedElement = null
        let selectedTab = PF2EncounterPlanner.ComponentType.CUSTOM

        let tmpCreatures = []
        let tmpHazards = []

        let addEncounterModal = $('#addEncounterModal');
        addEncounterModal.on('shown.bs.modal', function() {
            $("#addEncounterForm input").first().focus()
        });

        let renameEncounterModal = $('#renameEncounterModal')
        renameEncounterModal.on('shown.bs.modal', function() {
            $("#renameEncounterForm input").first().focus()
        });

        let setElementModal = $('#setElementModal')
        setElementModal.on('shown.bs.modal', function() {
            $('#setElementModalForm input').first().focus()
        })

        $("#custom-tab").on('show.bs.tab', _ => selectedTab = PF2EncounterPlanner.ComponentType.CUSTOM)
        $("#fight-tab").on('show.bs.tab', _ => selectedTab = PF2EncounterPlanner.ComponentType.FIGHT)
        $("#accomplishment-tab").on('show.bs.tab', _ => selectedTab = PF2EncounterPlanner.ComponentType.ACCOMPLISHMENT)
        $("#hazard-tab").on('show.bs.tab', _ => selectedTab = PF2EncounterPlanner.ComponentType.HAZARD)


        function addEncounter(name) {
            if (name != null && name.trim().length > 0)
                addEncounterToAccordion(session.addEncounter(name.trim()))
            $('#addEncounterForm input').val("")
            addEncounterModal.modal('hide')

        }


        function updatePlanner()
        {
            let accordion = $('#encountersAccordion')
            accordion.children().empty()

            for (let encounter of session.encounters) {
                addEncounterToAccordion(encounter)
            }
        }


        function addEncounterToAccordion(encounter)
        {
            if (encounter == null) return;

            let accordion = $('#encountersAccordion')
            let collapseId = `${encounter.id}-card-collapse`
            accordion.append(
                $("<div></div>")
                    .addClass('card')
                    .prop('id', `${encounter.id}-card`)
                    .append(
                    $("<div></div>")
                        .addClass('card-header')
                        .prop('id', `${encounter.id}-card-header`)
                        .append(
                            $("<h2></h2>")
                                .addClass("mb-0 accordion-card-header")
                                .append(
                                    $('<button></button>')
                                        .addClass('btn collapsed text-left largest-button')
                                        .prop('type', 'button')
                                        .attr('id', `${encounter.id}-card-header-button`)
                                        .attr('data-toggle', 'collapse')
                                        .attr('data-target', `#${collapseId}`)
                                        .attr('aria-expanded', 'false')
                                        .attr('aria-controls', collapseId)
                                        .text(encounter.name),
                                    $('<button></button>')
                                        .addClass('btn btn-outline-info btn-pad')
                                        .prop('type', 'button')
                                        .text("Rename")
                                        .click(_ => {
                                            selectedEncounter = encounter
                                            renameEncounterModal.modal('show')
                                            $('#renameEncounterForm input').first().val(encounter.name)
                                        }),
                                    $('<button></button>')
                                        .addClass('btn btn-outline-danger')
                                        .prop('type', 'button')
                                        .text("Delete")
                                        .click(_ => {
                                            session.removeEncounter(encounter)
                                            $(`#${encounter.id}-card`).remove()
                                        })
                                )
                        ),
                    $(`<div aria-labelledby='${encounter.id}-card-header' data-parent="#encountersAccordion"></div>`)
                        .addClass('collapse')
                        .prop('id', collapseId)
                        .append(
                            $('<div></div>')
                                .addClass('card-body')
                                .append(
                                    $('<div></div>')
                                        .addClass('list-group')
                                        .prop('id', `${encounter.id}-card-list`),
                                    $('<button></button>')
                                        .addClass('btn btn-outline-primary btn-top-margin')
                                        .prop('type', 'button')
                                        .text("Add encounter element")
                                        .click(_ => {
                                            selectedEncounter = encounter
                                            showSettingElement(true)
                                        })
                                )
                        )
                )
            )

            Sortable.create(document.getElementById(`${encounter.id}-card-list`), {
                animation: 150,
                onEnd: event => {
                    encounter.moveElement(event.oldIndex, event.newIndex)
                    session.saveSession()
                }
            })

            updateEncounterElements(encounter)
        }


        function updateEncounterElements(encounter)
        {
            let list = $(`#${encounter.id}-card-list`).empty()

            for (let element of encounter.elements) {
                let text = getElementText(element)

                list.append(
                    $('<a></a>')
                        .addClass('list-group-item')
                        .prop('id', element.id + "-item")
                        .html(text)
                        .click(_ => {
                            selectedElement = element
                            showSettingElement()
                        })
                )
            }
        }


        function renameEncounter(name)
        {
            if (name != null && name.trim().length > 0) {
                if (session.renameEncounter(selectedEncounter.name, name))
                {
                    let id = selectedEncounter.id

                    $(`#${id}-card-header h2 button`).first().text(selectedEncounter.name)
                }
            }

            renameEncounterModal.modal('hide')
        }


        function showSettingElement(adding = false)
        {
            if (adding)
                selectedElement = null

            $('#setElementModalLabel').text(adding ? "Add a new encounter element" : "Edit encounter element")
            $('#setElementModalConfirm').text(adding ? "Add encounter element" : "Edit encounter element")

            $('#elementName').val(selectedElement == null ? "" : selectedElement.name)

            let elementCustomXp = $('#elementCustomXp').val(null)
            let elementAccomplishmentLevel = $('#elementAccomplishmentLevel').val(PF2EncounterPlanner.AccomplishmentLevel.MINOR)

            $("#setElementModal").modal('show')

            if (selectedElement != null && selectedElement.component != null) {
                switch (selectedElement.component.type) {
                    case PF2EncounterPlanner.ComponentType.CUSTOM:
                        elementCustomXp.val(selectedElement.component.xp)
                        $('#custom-tab').tab('show')
                        break;
                    case PF2EncounterPlanner.ComponentType.FIGHT:
                        $('#fight-tab').tab('show')
                        break;
                    case PF2EncounterPlanner.ComponentType.ACCOMPLISHMENT:
                        elementAccomplishmentLevel.val(selectedElement.component.level)
                        $('#accomplishment-tab').tab('show')
                        break;
                    case PF2EncounterPlanner.ComponentType.HAZARD:
                        $('#hazard-tab').tab('show')
                        break;
                }
            }
        }


        function getElementText(element)
        {
            let text = element.name
            text = `<strong>[${element.component == null ? "?" : PF2EncounterPlanner.ComponentTypeName[element.component.type] || "?"}]</strong> ` + text

            if (element.component != null) {
                let xp = element.component.getEncounterXpPerPlayer()

                if (element.component.type === PF2EncounterPlanner.ComponentType.FIGHT) {
                    let amount = element.component.creatures.length
                    text += ` (${amount} creature${amount === 1 ? "" : "s"}, ${xp == null ? "?" : Math.floor(xp)} xp)`
                } else if (element.component.type === PF2EncounterPlanner.ComponentType.HAZARD) {
                    let amount = element.component.hazards.length
                    text += ` (${amount} hazard${amount === 1 ? "" : "s"}, ${xp == null ? "?" : Math.floor(xp)} xp)`
                } else {
                    text += ` (${xp == null ? "?" : Math.floor(xp)} xp)`
                }
            }

            return text
        }


        function confirmElementData()
        {
            if (selectedElement == null) {
                selectedElement = new PF2EncounterPlanner.EncounterElement($('#elementName').val())
                session.registerElement(selectedEncounter.name, selectedElement)

                updateEncounterElements(selectedEncounter)
            } else {
                selectedElement.name = $('#elementName').val()
            }

            switch (selectedTab) {
                case PF2EncounterPlanner.ComponentType.CUSTOM:
                    selectedElement.component = new PF2EncounterPlanner.CustomComponent($('#elementCustomXp').val())
                    break;
                case PF2EncounterPlanner.ComponentType.FIGHT:
                    selectedElement.component = new PF2EncounterPlanner.FightComponent()
                    selectedElement.component.creatures = tmpCreatures
                    break;
                case PF2EncounterPlanner.ComponentType.ACCOMPLISHMENT:
                    selectedElement.component = new PF2EncounterPlanner.AccomplishmentComponent($('#elementAccomplishmentLevel').val())
                    break;
                case PF2EncounterPlanner.ComponentType.HAZARD:
                    selectedElement.component = new PF2EncounterPlanner.HazardComponent()
                    selectedElement.component.hazards = tmpHazards
                    break;
            }

            session.saveSession()

            $(`#${selectedElement.id}-item`).html(getElementText(selectedElement))

            setElementModal.modal('hide')
        }


        Sortable.create(document.getElementById('encountersAccordion'), {
            animation: 150,
            onEnd: function (event) { session.moveEncounterIndex(event.oldIndex, event.newIndex) }
        })

        updatePlanner()
    </script>
</body>
</html>