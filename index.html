<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>PF2e Encounter Planner</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
</head>

<body>
    <!-- Body content -->
    <ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="planner-tab" data-toggle="tab" href="#planner" role="tab" aria-controls="planner" aria-selected="true">Encounter planner</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">Encounter history</a>
        </li>
    </ul>

    <div class="tab-content" id="mainContent">
        <div class="tab-pane fade show active" id="planner" role="tabpanel" aria-labelledby="planner-tab">
            <h1>Encounter planner</h1>

            <div class="accordion" id="encountersAccordion">
            </div>

            <button class="btn btn-outline-primary" data-toggle="modal" data-target="#addEncounterModal">
                Add new encounter
            </button>

            <div class="modal fade" id="addEncounterModal" tabindex="-1" role="dialog" aria-labelledby="addEncounterModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addEncounterModalLabel">Add a new encounter</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="addEncounterForm" action="javascript:addEncounter(encounterName.value)">
                                <div class="form-group">
                                    <label for="encounterName" class="col-form-label">Encounter name:</label>
                                    <input type="text" class="form-control" id="encounterName" name="encounterName">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="document.forms['addEncounterForm'].submit()">
                                Add encounter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="renameEncounterModal" tabindex="-1" role="dialog" aria-labelledby="renameEncounterModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="renameEncounterModalLabel">Rename the encounter</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="renameEncounterForm" action="javascript:renameEncounter(encounterNewName.value)">
                                <div class="form-group">
                                    <label for="encounterNewName" class="col-form-label">Encounter name:</label>
                                    <input type="text" class="form-control" id="encounterNewName" name="encounterNewName">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="document.forms['renameEncounterForm'].submit()">
                                Rename encounter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="setElementModal" tabindex="-1" role="dialog" aria-labelledby="setElementModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="setElementModalLabel">Add an encounter element</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="setElementModalForm" action="javascript:confirmElementData">
                                <div class="form-group">
                                    <label for="elementName" class="col-form-label">Encounter element name:</label>
                                    <input type="text" class="form-control" id="elementName" name="elementName">
                                </div>

                                <ul class="nav nav-tabs" id="elementTab" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="custom-tab" data-toggle="tab" href="#custom" role="tab" aria-controls="custom" aria-selected="true">Custom element</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="fight-tab" data-toggle="tab" href="#fight" role="tab" aria-controls="fight" aria-selected="false">Fight</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="accomplishment-tab" data-toggle="tab" href="#accomplishment" role="tab" aria-controls="accomplishment" aria-selected="false">Accomplishment</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="hazard-tab" data-toggle="tab" href="#hazard" role="tab" aria-controls="hazard" aria-selected="false">Hazard</a>
                                    </li>
                                </ul>

                                <div class="tab-content" id="elementTabContent">
                                    <div class="tab-pane fade show active" id="custom" role="tabpanel" aria-labelledby="custom-tab">
                                        <div class="form-group">
                                            <label for="elementCustomXp" class="col-form-label">Custom XP amount:</label>
                                            <input type="number" class="form-control" id="elementCustomXp" name="elementCustomXp">
                                        </div>
                                    </div>

                                    <div class="tab-pane fade" id="fight" role="tabpanel" aria-labelledby="fight-tab">
                                        <div class="form-group row">
                                            <label for="fightExpectedPlayerLevel" class="col-form-label col-sm-4">Expected player level:</label>
                                            <input type="number" id="fightExpectedPlayerLevel" class="col-sm-6" min="1" max="20">
                                        </div>

                                        <div class="form-group row">
                                            <label for="fightPlayerExpectedAmount" class="col-form-label col-sm-4">Expected amount of players:</label>
                                            <input type="number" id="fightPlayerExpectedAmount" class="col-sm-6" min="1">
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Experience per player: </label>
                                            <label class="col-sm-6 col-form-label"><strong id="fightXpLabel">?xp</strong></label>
                                        </div>

                                        <div class="form-group">
                                            <label class="fight-rating-label">Encounter rating:</label>
                                            <div class="btn-group" data-toggle="button" id="fightRatingSelector">
                                                <button class="btn btn-outline-success" id="label-trivial"> Trivial </button>
                                                <button class="btn btn-outline-info" id="label-low"> Low </button>
                                                <button class="btn btn-outline-primary" id="label-moderate"> Moderate </button>
                                                <button class="btn btn-outline-warning" id="label-severe"> Severe </button>
                                                <button class="btn btn-outline-danger" id="label-extreme"> Extreme </button>
                                                <button class="btn btn-outline-dark" id="label-impossible"> Impossible </button>
                                            </div>
                                        </div>

                                        <div class="accordion" id="elementCreatureAccordion"></div>

                                        <button class="btn btn-outline-primary btn-top-margin" id="fightAddCreature">
                                            Add more creatures
                                        </button>
                                    </div>

                                    <div class="tab-pane fade" id="accomplishment" role="tabpanel" aria-labelledby="accomplishment-tab">
                                        <label for="elementAccomplishmentLevel" class="col-form-label">Accomplishment level:</label>
                                        <select id="elementAccomplishmentLevel" name="elementAccomplishmentLevel">
                                            <option value="Minor accomplishment">Minor accomplishment</option>
                                            <option value="Moderate accomplishment">Moderate accomplishment</option>
                                            <option value="Major accomplishment">Major accomplishment</option>
                                        </select>
                                    </div>

                                    <div class="tab-pane fade" id="hazard" role="tabpanel" aria-labelledby="hazard-tab">
                                        <div class="form-group row">
                                            <label for="hazardExpectedPlayerLevel" class="col-form-label col-sm-4">Expected player level:</label>
                                            <input type="number" id="hazardExpectedPlayerLevel" class="col-sm-6" min="1" max="20">
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Experience per player: </label>
                                            <label class="col-sm-6 col-form-label"><strong id="hazardXpLabel">?xp</strong></label>
                                        </div>

                                        <div class="accordion" id="elementHazardAccordion"></div>

                                        <button class="btn btn-outline-primary btn-top-margin" id="hazardAddHazard">
                                            Add more hazards
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="setElementModalConfirm" onclick="confirmElementData()">
                                Add element
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
            Encounter history
        </div>
    </div>

    <!-- Scripts loaders -->
    <script src="build/pf2_encounter_planner.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        let session = PF2EncounterPlanner.Session.makeSession()
        let selectedEncounter = null
        let selectedElement = null
        let selectedTab = PF2EncounterPlanner.ComponentType.CUSTOM

        let tmpFightComponent = null
        let tmpHazardComponent = null

        let addEncounterModal = $('#addEncounterModal');
        addEncounterModal.on('shown.bs.modal', function() {
            $("#addEncounterForm input").first().focus()
        });

        let renameEncounterModal = $('#renameEncounterModal')
        renameEncounterModal.on('shown.bs.modal', function() {
            $("#renameEncounterForm input").first().focus()
        });

        let setElementModal = $('#setElementModal')
        setElementModal.on('shown.bs.modal', function() {
            $('#setElementModalForm input').first().focus()
        })

        $("#custom-tab").on('show.bs.tab', _ => selectedTab = PF2EncounterPlanner.ComponentType.CUSTOM)
        $("#fight-tab").on('show.bs.tab', _ => selectedTab = PF2EncounterPlanner.ComponentType.FIGHT)
        $("#accomplishment-tab").on('show.bs.tab', _ => selectedTab = PF2EncounterPlanner.ComponentType.ACCOMPLISHMENT)
        $("#hazard-tab").on('show.bs.tab', _ => selectedTab = PF2EncounterPlanner.ComponentType.HAZARD)


        function addEncounter(name) {
            if (name != null && name.trim().length > 0)
                addEncounterToAccordion(session.addEncounter(name.trim()))
            $('#addEncounterForm input').val("")
            addEncounterModal.modal('hide')
        }


        function updatePlanner()
        {
            let accordion = $('#encountersAccordion')
            accordion.children().empty()

            for (let encounter of session.encounters) {
                addEncounterToAccordion(encounter)
            }
        }


        function addEncounterToAccordion(encounter)
        {
            if (encounter == null) return;

            let accordion = $('#encountersAccordion')
            let collapseId = `${encounter.id}-card-collapse`
            accordion.append(
                $("<div></div>")
                    .addClass('card')
                    .prop('id', `${encounter.id}-card`)
                    .append(
                    $("<div></div>")
                        .addClass('card-header')
                        .prop('id', `${encounter.id}-card-header`)
                        .append(
                            $("<h2></h2>")
                                .addClass("mb-0 accordion-card-header")
                                .append(
                                    $('<button></button>')
                                        .addClass('btn collapsed text-left largest-button')
                                        .prop('type', 'button')
                                        .attr('id', `${encounter.id}-card-header-button`)
                                        .attr('data-toggle', 'collapse')
                                        .attr('data-target', `#${collapseId}`)
                                        .attr('aria-expanded', 'false')
                                        .attr('aria-controls', collapseId)
                                        .text(encounter.name),
                                    $('<button></button>')
                                        .addClass('btn btn-outline-info btn-pad')
                                        .prop('type', 'button')
                                        .text("Rename")
                                        .click(_ => {
                                            selectedEncounter = encounter
                                            renameEncounterModal.modal('show')
                                            $('#renameEncounterForm input').first().val(encounter.name)
                                        }),
                                    $('<button></button>')
                                        .addClass('btn btn-outline-danger')
                                        .prop('type', 'button')
                                        .text("Delete")
                                        .click(_ => {
                                            session.removeEncounter(encounter)
                                            $(`#${encounter.id}-card`).remove()
                                        })
                                )
                        ),
                    $(`<div aria-labelledby='${encounter.id}-card-header' data-parent="#encountersAccordion"></div>`)
                        .addClass('collapse')
                        .prop('id', collapseId)
                        .append(
                            $('<div></div>')
                                .addClass('card-body')
                                .append(
                                    $('<div></div>')
                                        .addClass('list-group')
                                        .prop('id', `${encounter.id}-card-list`),
                                    $('<button></button>')
                                        .addClass('btn btn-outline-primary btn-top-margin')
                                        .prop('type', 'button')
                                        .text("Add encounter element")
                                        .click(_ => {
                                            selectedEncounter = encounter
                                            showSettingElement(true)
                                        })
                                )
                        )
                )
            )

            Sortable.create(document.getElementById(`${encounter.id}-card-list`), {
                animation: 150,
                onEnd: event => {
                    encounter.moveElement(event.oldIndex, event.newIndex)
                    session.saveSession()
                }
            })

            updateEncounterElements(encounter)
        }


        function updateEncounterElements(encounter)
        {
            let list = $(`#${encounter.id}-card-list`).empty()

            for (let element of encounter.elements) {
                let text = getElementText(element)

                list.append(
                    $('<a></a>')
                        .addClass('list-group-item')
                        .prop('id', element.id + "-item")
                        .html(text)
                        .click(_ => {
                            selectedElement = element
                            showSettingElement()
                        })
                )
            }
        }


        function renameEncounter(name)
        {
            if (name != null && name.trim().length > 0) {
                if (session.renameEncounter(selectedEncounter.name, name))
                {
                    let id = selectedEncounter.id

                    $(`#${id}-card-header h2 button`).first().text(selectedEncounter.name)
                }
            }

            renameEncounterModal.modal('hide')
        }


        function showSettingElement(adding = false)
        {
            if (adding)
                selectedElement = null

            tmpFightComponent = null
            tmpHazardComponent = null

            $('#setElementModalLabel').text(adding ? "Add a new encounter element" : "Edit encounter element")
            $('#setElementModalConfirm').text(adding ? "Add encounter element" : "Edit encounter element")

            $('#elementName').val(selectedElement == null ? "" : selectedElement.name)

            let elementCustomXp = $('#elementCustomXp').val(null)
            let fightExpectedLevel = $('#fightExpectedPlayerLevel').val(session.getPlayerGroupLevel())
            let expectedPlayers = $(`#fightPlayerExpectedAmount`).val(session.params.players.length)
            let fightXp = $('#fightXpLabel').text("?xp")
            setRating(PF2EncounterPlanner.EncounterRating.TRIVIAL)
            $('#elementCreatureAccordion').empty()
            let elementAccomplishmentLevel = $('#elementAccomplishmentLevel').val(PF2EncounterPlanner.AccomplishmentLevel.MINOR)
            let hazardExpectedLevel = $('#hazardExpectedPlayerLevel').val(session.getPlayerGroupLevel())
            let hazardXp = $('#hazardXpLabel').text("?xp")
            $('#elementHazardAccordion').empty()

            $("#setElementModal").modal('show')

            if (selectedElement != null && selectedElement.component != null) {
                switch (selectedElement.component.type) {
                    case PF2EncounterPlanner.ComponentType.CUSTOM:
                        elementCustomXp.val(selectedElement.component.xp)
                        $('#custom-tab').tab('show')
                        break;
                    case PF2EncounterPlanner.ComponentType.FIGHT:
                        $('#fight-tab').tab('show')
                        tmpFightComponent = selectedElement.component.copy()
                        fightExpectedLevel.val(selectedElement.component.expectedLevel)
                        expectedPlayers.val(selectedElement.component.expectedPlayers)
                        let xp = selectedElement.component.getEncounterXpPerPlayer()
                        fightXp.text(`${xp != null ? Math.round(xp) : "?"}xp`)
                        setRating(selectedElement.component.getEncounterRating())
                        for (let creature of tmpFightComponent.creatures) {
                            addCreature(creature)
                        }
                        break;
                    case PF2EncounterPlanner.ComponentType.ACCOMPLISHMENT:
                        elementAccomplishmentLevel.val(selectedElement.component.level)
                        $('#accomplishment-tab').tab('show')
                        break;
                    case PF2EncounterPlanner.ComponentType.HAZARD:
                        $('#hazard-tab').tab('show')
                        tmpHazardComponent = selectedElement.component.copy()
                        hazardExpectedLevel.val(tmpHazardComponent.expectedLevel)
                        let hxp = tmpHazardComponent.getEncounterXpPerPlayer()
                        hazardXp.text(`${hxp != null ? Math.round(hxp) : "?"}xp`)
                        for (let hazard of tmpHazardComponent.hazards) {
                            addHazard(hazard)
                        }
                        break;
                }
            }

            if (tmpFightComponent == null) tmpFightComponent = new PF2EncounterPlanner.FightComponent()
            if (tmpHazardComponent == null) tmpHazardComponent= new PF2EncounterPlanner.HazardComponent()
        }


        function setRating(rating)
        {
            $('#fightRatingSelector button').removeClass('active')
            $('#fightRatingSelector').val(rating)
            $(`#label-${rating}`).addClass('active')
        }


        function getElementText(element)
        {
            let text = element.name
            text = `<strong>[${element.component == null ? "?" : PF2EncounterPlanner.ComponentTypeName[element.component.type] || "?"}]</strong> ` + text

            if (element.component != null) {
                let xp = element.component.getEncounterXpPerPlayer()

                if (element.component.type === PF2EncounterPlanner.ComponentType.FIGHT) {
                    let amount = element.component.creatures.map(c => c.amount).reduce((a, b) => a + b, 0)
                    text += ` (${amount} creature${amount === 1 ? "" : "s"}, ${xp == null ? "?" : Math.floor(xp)} xp)`
                } else if (element.component.type === PF2EncounterPlanner.ComponentType.HAZARD) {
                    let amount = element.component.hazards.map(h => h.amount).reduce((a, b) => a + b, 0)
                    text += ` (${amount} hazard${amount === 1 ? "" : "s"}, ${xp == null ? "?" : Math.floor(xp)} xp)`
                } else {
                    text += ` (${xp == null ? "?" : Math.floor(xp)} xp)`
                }
            }

            return text
        }


        function confirmElementData()
        {
            if (selectedElement == null) {
                selectedElement = new PF2EncounterPlanner.EncounterElement($('#elementName').val())
                session.registerElement(selectedEncounter.name, selectedElement)

                updateEncounterElements(selectedEncounter)
            } else {
                selectedElement.name = $('#elementName').val()
            }

            switch (selectedTab) {
                case PF2EncounterPlanner.ComponentType.CUSTOM:
                    selectedElement.component = new PF2EncounterPlanner.CustomComponent($('#elementCustomXp').val())
                    break;
                case PF2EncounterPlanner.ComponentType.FIGHT:
                    selectedElement.component = tmpFightComponent
                    break;
                case PF2EncounterPlanner.ComponentType.ACCOMPLISHMENT:
                    selectedElement.component = new PF2EncounterPlanner.AccomplishmentComponent($('#elementAccomplishmentLevel').val())
                    break;
                case PF2EncounterPlanner.ComponentType.HAZARD:
                    selectedElement.component = tmpHazardComponent
                    break;
            }

            session.saveSession()

            $(`#${selectedElement.id}-item`).html(getElementText(selectedElement))

            setElementModal.modal('hide')
        }


        function updateFightInterface()
        {
            setRating(tmpFightComponent.getEncounterRating())
            let xp = tmpFightComponent.getEncounterXpPerPlayer()
            $('#fightXpLabel').text(`${xp != null ? Math.round(xp) : "?"}xp`)
        }


        function addCreature(creature)
        {
            let accordion = $('#elementCreatureAccordion')
            let collapseId = `${creature.id}-card-collapse`
            accordion.append(
                $("<div></div>")
                    .addClass('card')
                    .prop('id', `${creature.id}-card`)
                    .append(
                        $("<div></div>")
                            .addClass('card-header')
                            .prop('id', `${creature.id}-card-header`)
                            .append(
                                $("<h2></h2>")
                                    .addClass("mb-0 accordion-card-header")
                                    .append(
                                        $('<a></a>')
                                            .addClass('btn collapsed text-left largest-button handle')
                                            .attr('id', `${creature.id}-card-header-text`),
                                        $('<a></a>')
                                            .addClass('font-italic btn')
                                            .attr('id', `${creature.id}-card-header-xp`),
                                        $('<button></button>')
                                            .addClass('btn btn-outline-info btn-pad')
                                            .prop('id',  `${creature.id}-collapser`)
                                            .attr('type', 'button')
                                            .attr('data-toggle', 'collapse')
                                            .attr('data-target', `#${collapseId}`)
                                            .attr('aria-expanded', 'false')
                                            .attr('aria-controls', collapseId)
                                            .text("Edit"),
                                        $('<button></button>')
                                            .addClass('btn btn-outline-danger')
                                            .prop('type', 'button')
                                            .text("Delete")
                                            .click(_ => {
                                                let index = tmpFightComponent.creatures.findIndex(c => c.id === creature.id)
                                                tmpFightComponent.creatures.splice(index, 1)
                                                $(`#${creature.id}-card`).remove()
                                            })
                                    )
                            ),
                        $(`<div aria-labelledby='${creature.id}-card-header' data-parent="#elementCreatureAccordion"></div>`)
                            .addClass('collapse')
                            .prop('id', collapseId)
                            .append(
                                $('<div></div>')
                                    .addClass('card-body')
                                    .append(
                                        $('<div></div>')
                                            .addClass('form-group row')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('col-form-label col-sm-4')
                                                    .text("Creature name")
                                                    .prop('for', `${creature.id}-name`),
                                                $('<input>')
                                                    .addClass('col-sm-6')
                                                    .prop('id', `${creature.id}-name`)
                                                    .attr('type', 'text')
                                                    .change(function () {
                                                        creature.name = $(this).val().trim()
                                                        setCreatureHeader(creature)
                                                    })
                                            ),
                                        $('<div></div>')
                                            .addClass('form-group row')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('col-form-label col-sm-4')
                                                    .text("Creature level:")
                                                    .prop('for', `${creature.id}-level`),
                                                $('<input>')
                                                    .addClass('col-sm-6')
                                                    .prop('id', `${creature.id}-level`)
                                                    .attr('type', 'number')
                                                    .change(function () {
                                                        creature.level = Math.max(-1, Math.min($(this).val(), 24))
                                                        $(this).val(creature.level)
                                                        updateFightInterface()
                                                        setCreatureHeader(creature)
                                                    })
                                            ),
                                        $('<div></div>')
                                            .addClass('form-group row')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('col-form-label col-sm-4')
                                                    .text("Amount of creatures:")
                                                    .prop('for', `${creature.id}-amount`),
                                                $('<input>')
                                                    .addClass('col-sm-6')
                                                    .prop('id', `${creature.id}-amount`)
                                                    .attr('type', 'number')
                                                    .change(function () {
                                                        creature.amount = Math.max(1, $(this).val())
                                                        $(this).val(creature.amount)
                                                        updateFightInterface()
                                                        setCreatureHeader(creature)
                                                    })
                                            ),
                                        $('<div></div>')
                                            .addClass('form-group row')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('col-form-label col-sm-4')
                                                    .text("Link to monster (optional):")
                                                    .prop('for', `${creature.id}-link`),
                                                $('<input>')
                                                    .addClass('col-sm-6')
                                                    .prop('id', `${creature.id}-link`)
                                                    .attr('type', 'text')
                                                    .change(function () {
                                                        creature.link = $(this).val().trim()
                                                        setCreatureHeader(creature)
                                                    })
                                            )
                                    )
                            )
                    )
            )

            $(`#${creature.id}-name`).val(creature.name)
            $(`#${creature.id}-level`).val(creature.level)
            $(`#${creature.id}-amount`).val(creature.amount)
            $(`#${creature.id}-link`).val(creature.link)
            setCreatureHeader(creature)
        }


        function setCreatureHeader(creature)
        {
            let htmlText = creature.name != null && creature.name.length > 0 ? creature.name : "Unnamed creature";

            htmlText = `<strong>[Lvl ${creature.level != null ? creature.level : "?"}]</strong> ` + htmlText;

            htmlText += ` &times; ${creature.amount != null ? creature.amount : "?"}`;

            if (creature.link != null && creature.link.length > 0)
                htmlText += ` (<a href='${creature.link}' target="_blank">link</a>)`
            $(`#${creature.id}-card-header-text`).html(htmlText)

            let tmp = tmpFightComponent.creatures
            tmpFightComponent.creatures = [creature]
            let xp = tmpFightComponent.getEncounterXpPerPlayer()
            tmpFightComponent.creatures = tmp
            $(`#${creature.id}-card-header-xp`)
                .text((xp != null ? Math.round(xp) : "?") + "xp")
        }


        function updateHazardInterface()
        {
            let xp = tmpHazardComponent.getEncounterXpPerPlayer()
            $('#fightXpLabel').text(`${xp != null ? Math.round(xp) : "?"}xp`)
        }


        function addHazard(hazard)
        {
            let accordion = $('#elementHazardAccordion')
            let collapseId = `${hazard.id}-card-collapse`
            accordion.append(
                $("<div></div>")
                    .addClass('card')
                    .prop('id', `${hazard.id}-card`)
                    .append(
                        $("<div></div>")
                            .addClass('card-header')
                            .prop('id', `${hazard.id}-card-header`)
                            .append(
                                $("<h2></h2>")
                                    .addClass("mb-0 accordion-card-header")
                                    .append(
                                        $('<a></a>')
                                            .addClass('btn collapsed text-left largest-button handle')
                                            .attr('id', `${hazard.id}-card-header-text`),
                                        $('<a></a>')
                                            .addClass('font-italic btn')
                                            .attr('id', `${hazard.id}-card-header-xp`),
                                        $('<button></button>')
                                            .addClass('btn btn-outline-info btn-pad')
                                            .prop('id',  `${hazard.id}-collapser`)
                                            .attr('type', 'button')
                                            .attr('data-toggle', 'collapse')
                                            .attr('data-target', `#${collapseId}`)
                                            .attr('aria-expanded', 'false')
                                            .attr('aria-controls', collapseId)
                                            .text("Edit"),
                                        $('<button></button>')
                                            .addClass('btn btn-outline-danger')
                                            .prop('type', 'button')
                                            .text("Delete")
                                            .click(_ => {
                                                let index = tmpHazardComponent.hazards.findIndex(c => c.id === hazard.id)
                                                tmpHazardComponent.hazards.splice(index, 1)
                                                $(`#${hazard.id}-card`).remove()
                                            })
                                    )
                            ),
                        $(`<div aria-labelledby='${hazard.id}-card-header' data-parent="#elementHazardAccordion"></div>`)
                            .addClass('collapse')
                            .prop('id', collapseId)
                            .append(
                                $('<div></div>')
                                    .addClass('card-body')
                                    .append(
                                        $('<div></div>')
                                            .addClass('form-group row')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('col-form-label col-sm-4')
                                                    .text("Hazard name")
                                                    .prop('for', `${hazard.id}-name`),
                                                $('<input>')
                                                    .addClass('col-sm-6')
                                                    .prop('id', `${hazard.id}-name`)
                                                    .attr('type', 'text')
                                                    .change(function () {
                                                        hazard.name = $(this).val().trim()
                                                        setCreatureHeader(hazard)
                                                    })
                                            ),
                                        $('<div></div>')
                                            .addClass('form-group row')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('col-form-label col-sm-4')
                                                    .text("Hazard level:")
                                                    .prop('for', `${hazard.id}-level`),
                                                $('<input>')
                                                    .addClass('col-sm-6')
                                                    .prop('id', `${hazard.id}-level`)
                                                    .attr('type', 'number')
                                                    .change(function () {
                                                        hazard.level = Math.max(-1, Math.min($(this).val(), 24))
                                                        $(this).val(hazard.level)
                                                        updateHazardInterface()
                                                        setHazardHeader(hazard)
                                                    })
                                            ),
                                        $('<div></div>')
                                            .addClass('form-group form-check')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('form-check-label col-sm-4 text-right label-pad-right')
                                                    .text("Is hazard complex ?")
                                                    .css('padding-right', '2em')
                                                    .prop('for', `${hazard.id}-isComplex`),
                                                $('<input>')
                                                    .addClass('form-check-input')
                                                    .prop('id', `${hazard.id}-isComplex`)
                                                    .attr('type', 'checkbox')
                                                    .change(function () {
                                                        hazard.isComplex = $(this).prop('checked')
                                                        updateHazardInterface()
                                                        setHazardHeader(hazard)
                                                    }),
                                            ),
                                        $('<div></div>')
                                            .addClass('form-group row')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('col-form-label col-sm-4')
                                                    .text("Amount of hazards:")
                                                    .prop('for', `${hazard.id}-amount`),
                                                $('<input>')
                                                    .addClass('col-sm-6')
                                                    .prop('id', `${hazard.id}-amount`)
                                                    .attr('type', 'number')
                                                    .change(function () {
                                                        hazard.amount = Math.max(1, $(this).val())
                                                        $(this).val(hazard.amount)
                                                        updateHazardInterface()
                                                        setHazardHeader(hazard)
                                                    })
                                            ),
                                        $('<div></div>')
                                            .addClass('form-group row')
                                            .append(
                                                $('<label></label>')
                                                    .addClass('col-form-label col-sm-4')
                                                    .text("Link to hazard (optional):")
                                                    .prop('for', `${hazard.id}-link`),
                                                $('<input>')
                                                    .addClass('col-sm-6')
                                                    .prop('id', `${hazard.id}-link`)
                                                    .attr('type', 'text')
                                                    .change(function () {
                                                        hazard.link = $(this).val().trim()
                                                        setCreatureHeader(hazard)
                                                    })
                                            )
                                    )
                            )
                    )
            )

            $(`#${hazard.id}-name`).val(hazard.name)
            $(`#${hazard.id}-level`).val(hazard.level)
            $(`#${hazard.id}-isComplex`).prop('checked', hazard.isComplex)
            $(`#${hazard.id}-amount`).val(hazard.amount)
            $(`#${hazard.id}-link`).val(hazard.link)
            setHazardHeader(hazard)
        }


        function setHazardHeader(hazard)
        {
            let htmlText = hazard.name != null && hazard.name.length > 0 ? hazard.name : "Unnamed hazard";

            htmlText = `<strong>[Lvl ${hazard.level != null ? hazard.level : "?"}]</strong> ` + htmlText;

            htmlText += ` &times; ${hazard.amount != null ? hazard.amount : "?"}`;

            if (hazard.link != null && hazard.link.length > 0)
                htmlText += ` (<a href='${hazard.link}' target="_blank">link</a>)`
            $(`#${hazard.id}-card-header-text`).html(htmlText)

            let tmp = tmpHazardComponent.hazards
            tmpHazardComponent.hazards = [hazard]
            let xp = tmpHazardComponent.getEncounterXpPerPlayer()
            tmpHazardComponent.hazards = tmp
            $(`#${hazard.id}-card-header-xp`)
                .text((xp != null ? Math.round(xp) : "?") + "xp")
        }


        Sortable.create(document.getElementById('encountersAccordion'), {
            animation: 150,
            onEnd: function (event) { session.moveEncounterIndex(event.oldIndex, event.newIndex) }
        })

        updatePlanner()

        $('#fightPlayerExpectedAmount').change(function() {
            tmpFightComponent.expectedPlayers = Math.max(1, $(this).val())
            $(this).val(tmpFightComponent.expectedPlayers)
            updateFightInterface()
            for (let creature of tmpFightComponent.creatures)
                setCreatureHeader(creature)
        })

        $('#fightExpectedPlayerLevel').change(function() {
            tmpFightComponent.expectedLevel = Math.min(20, Math.max(1, $(this).val()))
            $(this).val(tmpFightComponent.expectedLevel)
            updateFightInterface()
            for (let creature of tmpFightComponent.creatures)
                setCreatureHeader(creature)
        })


        Sortable.create(document.getElementById('elementCreatureAccordion'), {
            animation: 150,
            handle: '.handle',
            onEnd: event => {
                let e = tmpFightComponent.creatures[event.oldIndex]
                tmpFightComponent.creatures.splice(event.oldIndex, 1)
                tmpFightComponent.creatures.splice(event.newIndex, 0, e)
                session.saveSession()
            }
        })


        $('#hazardExpectedPlayerLevel').change(function() {
            tmpHazardComponent.expectedLevel = Math.min(20, Math.max(1, $(this).val()))
            $(this).val(tmpHazardComponent.expectedLevel)
            updateFightInterface()
            for (let hazard of tmpHazardComponent.hazards)
                setHazardHeader(hazard)
        })


        Sortable.create(document.getElementById('elementHazardAccordion'), {
            animation: 150,
            handle: '.handle',
            onEnd: event => {
                let e = tmpHazardComponent.hazards[event.oldIndex]
                tmpHazardComponent.hazards.splice(event.oldIndex, 1)
                tmpHazardComponent.hazards.splice(event.newIndex, 0, e)
                session.saveSession()
            }
        })


        $('#fightAddCreature').click(_ => {
            let creature = new PF2EncounterPlanner.Creature(null, null, null, null, tmpFightComponent.getNewCreatureId())
            addCreature(creature)
            tmpFightComponent.creatures.push(creature)

            $(`#${creature.id}-collapser`).dropdown('show')
        })

        $('#hazardAddHazard').click(_ => {
            let hazard = new PF2EncounterPlanner.Hazard(null, null, false, null, null, tmpHazardComponent.getNewHazardId())
            addHazard(hazard)
            tmpHazardComponent.hazards.push(hazard)

            $(`#${hazard.id}-collapser`).dropdown('show')
        })
    </script>
</body>
</html>